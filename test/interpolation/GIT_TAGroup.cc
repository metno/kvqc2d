
#include "GapInterpolationTestBase.hh"

TEST_F(GapInterpolationTest, TAGroup)
{
    DataList data(4200, 211, 342);
    data.add("2012-03-25 18:00:00",      10.4,      10.4, "0111000000100010", "")
        .add("2012-03-25 19:00:00",       9.1,       9.1, "0111000000100010", "")
        .add("2012-03-25 20:00:00",       8.6,       8.6, "0111000000100010", "")
        .add("2012-03-25 21:00:00",       4.1,       4.1, "0111000000100010", "")
        .add("2012-03-25 22:00:00",       2.9,       2.9, "0111000000100010", "")
        .add("2012-03-25 23:00:00",       2.0,       2.0, "0111000000100010", "")
        .add("2012-03-26 00:00:00",       1.6,       1.6, "0111000000100010", "")
        .add("2012-03-26 01:00:00",       0.1,       0.1, "0111000000100010", "");
    data.setStation(17150).setType(342)
        .add("2012-03-25 18:00:00",      10.2,      10.2, "0111000000100010", "")
        .add("2012-03-25 19:00:00",       9.1,       9.1, "0111000000100010", "")
        .add("2012-03-25 20:00:00",       7.8,       7.8, "0111000000100010", "")
        .add("2012-03-25 21:00:00",       7.4,       7.4, "0111000000100010", "")
        .add("2012-03-25 22:00:00",       6.8,       6.8, "0111000000100010", "")
        .add("2012-03-25 23:00:00",       4.8,       4.8, "0111000000100010", "")
        .add("2012-03-26 00:00:00",       4.1,       4.1, "0111000000100010", "")
        .add("2012-03-26 01:00:00",       2.4,       2.4, "0111000000100010", "");
    data.setStation(18700).setType(330)
        .add("2012-03-25 18:00:00",      11.5,      11.5, "0111000000100010", "")
        .add("2012-03-25 19:00:00",      10.1,      10.1, "0111000000100010", "")
        .add("2012-03-25 20:00:00",       7.4,       7.4, "0111000000100010", "")
        .add("2012-03-25 21:00:00",       6.1,       6.1, "0111000000100010", "")
        .add("2012-03-25 22:00:00",  -32767.0,  -32767.0, "0000003000000000", "") // not fake
        .add("2012-03-25 23:00:00",       5.3,       5.3, "0110000000100010", "")
        .add("2012-03-26 00:00:00",       4.6,       4.6, "0111000000100010", "")
        .add("2012-03-26 01:00:00",       4.0,       4.0, "0111000000100010", "");
    data.setStation(20301).setType(330)
        .add("2012-03-25 18:00:00",      11.7,      11.7, "0111000000100010", "")
        .add("2012-03-25 19:00:00",       9.1,       9.1, "0111000000100010", "")
        .add("2012-03-25 20:00:00",       7.0,       7.0, "0111000000100010", "")
        .add("2012-03-25 21:00:00",       5.2,       5.2, "0111000000100010", "")
        .add("2012-03-25 22:00:00",       4.4,       4.4, "0111000000100010", "")
        .add("2012-03-25 23:00:00",       3.7,       3.7, "0111000000100010", "")
        .add("2012-03-26 00:00:00",       3.3,       3.3, "0111000000100010", "")
        .add("2012-03-26 01:00:00",       2.8,       2.8, "0111000000100010", "");
    data.setParam(213);
    data.setStation(4200).setType(342)
        .add("2012-03-25 18:00:00",      10.1,      10.1, "0111000000000000", "")
        .add("2012-03-25 19:00:00",       9.1,       9.1, "0111000000000000", "")
        .add("2012-03-25 20:00:00",       8.2,       8.2, "0111000000000000", "")
        .add("2012-03-25 21:00:00",       4.1,       4.1, "0111000000000000", "")
        .add("2012-03-25 22:00:00",       2.6,       2.6, "0111000000000000", "")
        .add("2012-03-25 23:00:00",       2.0,       2.0, "0111000000000000", "")
        .add("2012-03-26 00:00:00",       1.6,       1.6, "0111000000000000", "")
        .add("2012-03-26 01:00:00",       0.0,       0.0, "0111000000000000", "");
    data.setStation(17150).setType(342)
        .add("2012-03-25 18:00:00",      10.2,      10.2, "0111000000000000", "")
        .add("2012-03-25 19:00:00",       9.1,       9.1, "0111000000000000", "")
        .add("2012-03-25 20:00:00",       7.8,       7.8, "0111000000000000", "")
        .add("2012-03-25 21:00:00",       7.4,       7.4, "0111000000000000", "")
        .add("2012-03-25 22:00:00",       6.8,       6.8, "0111000000000000", "")
        .add("2012-03-25 23:00:00",       4.8,       4.8, "0111000000000000", "")
        .add("2012-03-26 00:00:00",       3.5,       3.5, "0111000000000000", "")
        .add("2012-03-26 01:00:00",       2.3,       2.3, "0111000000000000", "");
    data.setStation(18700).setType(330)
        .add("2012-03-25 18:00:00",      11.5,      11.5, "0111000000000000", "")
        .add("2012-03-25 19:00:00",      10.1,      10.1, "0111000000000000", "")
        .add("2012-03-25 20:00:00",       7.4,       7.4, "0111000000000000", "")
        .add("2012-03-25 21:00:00",       6.1,       6.1, "0111000000000000", "")
        .add("2012-03-25 22:00:00",       5.7,       5.7, "0110000000000000", "") // fake, original missing
        .add("2012-03-25 23:00:00",  -32767.0,  -32767.0, "0000003000000000", "") // fake, original = 5.0
        .add("2012-03-26 00:00:00",       4.6,       4.6, "0111000000000000", "")
        .add("2012-03-26 01:00:00",       4.0,       4.0, "0111000000000000", "");
    data.setStation(20301).setType(330)
        .add("2012-03-25 18:00:00",      11.7,      11.7, "0111000000000000", "")
        .add("2012-03-25 19:00:00",       9.1,       9.1, "0111000000000000", "")
        .add("2012-03-25 20:00:00",       7.0,       7.0, "0111000000000000", "")
        .add("2012-03-25 21:00:00",       5.1,       5.1, "0111000000000000", "")
        .add("2012-03-25 22:00:00",       4.3,       4.3, "0111000000000000", "")
        .add("2012-03-25 23:00:00",       3.6,       3.6, "0111000000000000", "")
        .add("2012-03-26 00:00:00",       3.2,       3.2, "0111000000000000", "")
        .add("2012-03-26 01:00:00",       2.6,       2.6, "0111000000000000", "");
    data.setParam(215);
    data.setStation(4200).setType(342)
        .add("2012-03-25 18:00:00",      12.9,      12.9, "0111000000000000", "")
        .add("2012-03-25 19:00:00",      10.5,      10.5, "0111000000000000", "")
        .add("2012-03-25 20:00:00",      10.3,      10.3, "0111000000000000", "")
        .add("2012-03-25 21:00:00",       8.5,       8.5, "0111000000000000", "")
        .add("2012-03-25 22:00:00",       4.8,       4.8, "0111000000000000", "")
        .add("2012-03-25 23:00:00",       3.8,       3.8, "0111000000000000", "")
        .add("2012-03-26 00:00:00",       2.9,       2.9, "0111000000000000", "")
        .add("2012-03-26 01:00:00",       1.8,       1.8, "0111000000000000", "");
    data.setStation(17150).setType(342)
        .add("2012-03-25 18:00:00",      11.2,      11.2, "0111000000000000", "")
        .add("2012-03-25 19:00:00",      10.2,      10.2, "0111000000000000", "")
        .add("2012-03-25 20:00:00",       9.1,       9.1, "0111000000000000", "")
        .add("2012-03-25 21:00:00",       7.8,       7.8, "0111000000000000", "")
        .add("2012-03-25 22:00:00",       7.4,       7.4, "0111000000000000", "")
        .add("2012-03-25 23:00:00",       6.9,       6.9, "0111000000000000", "")
        .add("2012-03-26 00:00:00",       4.8,       4.8, "0111000000000000", "")
        .add("2012-03-26 01:00:00",       4.2,       4.2, "0111000000000000", "");
    data.setStation(18700).setType(330)
        .add("2012-03-25 18:00:00",      13.0,      13.0, "0111000000000000", "")
        .add("2012-03-25 19:00:00",      11.6,      11.6, "0111000000000000", "")
        .add("2012-03-25 20:00:00",      10.1,      10.1, "0111000000000000", "")
        .add("2012-03-25 21:00:00",       7.3,       7.3, "0111000000000000", "")
        .add("2012-03-25 22:00:00",       6.1,       6.1, "0110000000000000", "") // fake, original missing
        .add("2012-03-25 23:00:00",  -32767.0,  -32767.0, "0000003000000000", "") // fake, original = 5.7
        .add("2012-03-26 00:00:00",       5.4,       5.4, "0111000000000000", "")
        .add("2012-03-26 01:00:00",       4.6,       4.6, "0111000000000000", "");
    data.setStation(20301).setType(330)
        .add("2012-03-25 18:00:00",      13.5,      13.5, "0111000000000000", "")
        .add("2012-03-25 19:00:00",      11.7,      11.7, "0111000000000000", "")
        .add("2012-03-25 20:00:00",       9.1,       9.1, "0111000000000000", "")
        .add("2012-03-25 21:00:00",       7.0,       7.0, "0111000000000000", "")
        .add("2012-03-25 22:00:00",       5.4,       5.4, "0111000000000000", "")
        .add("2012-03-25 23:00:00",       5.1,       5.1, "0111000000000000", "")
        .add("2012-03-26 00:00:00",       4.0,       4.0, "0111000000000000", "")
        .add("2012-03-26 01:00:00",       3.3,       3.3, "0111000000000000", "");
    ASSERT_NO_THROW(data.insert(db));

    std::stringstream config;
    config << "Start_YYYY = 2012\n"
           << "Start_MM   =   03\n"
           << "Start_DD   =   25\n"
           << "Start_hh   =   18\n"
           << "End_YYYY   = 2012\n"
           << "End_MM     =   03\n"
           << "End_DD     =   26\n"
           << "End_hh     =   01\n"
           << "TypeId     =  330\n"
           << "Parameter  =  par=211,minPar=213,maxPar=215,offsetCorrectionLimit=15,fluctuationLevel=0.5\n"
           << "Parameter  =  par=178,minVal=800,maxVal=1200,offsetCorrectionLimit=5\n";
    AlgorithmConfig params;
    params.Parse(config);

    ASSERT_CONFIGURE(algo, params);
    ASSERT_RUN(algo, bc, 5);
    EXPECT_NEAR(5.9, bc->update(0).corrected(), 0.2);
    EXPECT_NEAR(5.2, bc->update(1).corrected(), 0.2);
    EXPECT_NEAR(4.6, bc->update(2).corrected(), 0.2);
    EXPECT_NEAR(5.9, bc->update(3).corrected(), 0.2);
    EXPECT_NEAR(5.3, bc->update(4).corrected(), 0.2);

    ASSERT_RUN(algo, bc, 0);
}
