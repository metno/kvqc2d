
#include "GapInterpolationTestBase.hh"

TEST_F(GapInterpolationTest, MinMaxTooFar)
{
    DataList data(99752, 211, 330);
    data.add("2012-07-10 08:00:00",       3.2,       3.2, "0111000000100010", "")
        .add("2012-07-10 09:00:00",       2.7,       2.7, "0111000000100010", "")
        .add("2012-07-10 10:00:00",       2.9,       2.9, "0111000000100010", "")
        .add("2012-07-10 11:00:00",       3.0,       3.0, "0111000000100010", "")
        .add("2012-07-10 12:00:00",       3.3,       3.3, "0111000000100010", "")
        .add("2012-07-10 13:00:00",       3.6,       3.6, "0111000000100010", "")
        .add("2012-07-10 14:00:00",  -32767.0,  -32767.0, "0000003000000000", "")
        .add("2012-07-10 15:00:00",       4.1,       4.1, "0111000000100010", "")
        .add("2012-07-10 16:00:00",       4.3,       4.3, "0111000000100010", "")
        .add("2012-07-10 17:00:00",       4.1,       4.1, "0111000000100010", "")
        .add("2012-07-10 18:00:00",       4.0,       4.0, "0111000000100010", "")
        .add("2012-07-10 19:00:00",       3.3,       3.3, "0111000000100010", "")
        .add("2012-07-10 20:00:00",  -32767.0,  -32767.0, "0000003000000000", "")
        .add("2012-07-10 21:00:00",       3.3,       3.3, "0111000000100010", "")
        .add("2012-07-10 22:00:00",  -32767.0,  -32767.0, "0000003000000000", "")
        .add("2012-07-10 23:00:00",       3.1,       3.1, "0111000000100010", "")
        .add("2012-07-11 00:00:00",       3.1,       3.1, "0111000000100010", "");
    data.setParam(213);
    data.setStation(99752).setType(330)
        .add("2012-07-10 08:00:00",       3.1,       3.1, "0111000000000000", "")
        .add("2012-07-10 09:00:00",       2.7,       2.7, "0111000000000000", "")
        .add("2012-07-10 10:00:00",       2.7,       2.7, "0111000000000000", "")
        .add("2012-07-10 11:00:00",       2.7,       2.7, "0111000000000000", "")
        .add("2012-07-10 12:00:00",       2.9,       2.9, "0111000000000000", "")
        .add("2012-07-10 13:00:00",       3.3,       3.3, "0111000000000000", "")
        .add("2012-07-10 14:00:00",  -32767.0,  -32767.0, "0000003000000000", "")
        .add("2012-07-10 15:00:00",       3.7,       3.7, "0110000000000000", "")
        .add("2012-07-10 16:00:00",       4.0,       4.0, "0111000000000000", "")
        .add("2012-07-10 17:00:00",       3.7,       3.7, "0111000000000000", "")
        .add("2012-07-10 18:00:00",       3.7,       3.7, "0111000000000000", "")
        .add("2012-07-10 19:00:00",       3.3,       3.3, "0111000000000000", "")
        .add("2012-07-10 20:00:00",  -32767.0,  -32767.0, "0000003000000000", "")
        .add("2012-07-10 21:00:00",       3.1,       3.1, "0110000000000000", "")
        .add("2012-07-10 22:00:00",  -32767.0,  -32767.0, "0000003000000000", "")
        .add("2012-07-10 23:00:00",       3.0,       3.0, "0110000000000000", "")
        .add("2012-07-11 00:00:00",       3.0,       3.0, "0111000000000000", "");
    data.setParam(215);
    data.setStation(99752).setType(330)
        .add("2012-07-10 08:00:00",       3.6,       3.6, "0111000000000000", "")
        .add("2012-07-10 09:00:00",       3.3,       3.3, "0111000000000000", "")
        .add("2012-07-10 10:00:00",       3.1,       3.1, "0111000000000000", "")
        .add("2012-07-10 11:00:00",       3.0,       3.0, "0111000000000000", "")
        .add("2012-07-10 12:00:00",       3.3,       3.3, "0111000000000000", "")
        .add("2012-07-10 13:00:00",       3.7,       3.7, "0111000000000000", "")
        .add("2012-07-10 14:00:00",  -32767.0,  -32767.0, "0000003000000000", "")
        .add("2012-07-10 15:00:00",       4.1,       4.1, "0110000000000000", "")
        .add("2012-07-10 16:00:00",       4.4,       4.4, "0111000000000000", "")
        .add("2012-07-10 17:00:00",       4.6,       4.6, "0111000000000000", "")
        .add("2012-07-10 18:00:00",       4.2,       4.2, "0111000000000000", "")
        .add("2012-07-10 19:00:00",       4.0,       4.0, "0111000000000000", "")
        .add("2012-07-10 20:00:00",  -32767.0,  -32767.0, "0000003000000000", "")
        .add("2012-07-10 21:00:00",       3.5,       3.5, "0110000000000000", "")
        .add("2012-07-10 22:00:00",  -32767.0,  -32767.0, "0000003000000000", "")
        .add("2012-07-10 23:00:00",       3.1,       3.1, "0110000000000000", "")
        .add("2012-07-11 00:00:00",       3.1,       3.1, "0111000000000000", "");
    data.setParam(211);
    data.setStation(99754).setType(330);
    data.add("2012-07-10 08:00:00",       3.7,       3.7, "0111000000100010", "")
        .add("2012-07-10 09:00:00",       3.4,       3.4, "0111000000100010", "")
        .add("2012-07-10 10:00:00",       3.4,       3.4, "0111000000100010", "")
        .add("2012-07-10 11:00:00",       3.5,       3.5, "0111000000100010", "")
        .add("2012-07-10 12:00:00",       3.5,       3.5, "0111000000100010", "")
        .add("2012-07-10 12:00:00",       3.5,       3.5, "0111000000100010", "")
        .add("2012-07-10 13:00:00",       4.2,       4.2, "0111000000100010", "")
        .add("2012-07-10 14:00:00",       4.8,       4.8, "0111000000100010", "")
        .add("2012-07-10 15:00:00",       5.6,       5.6, "0111000000100010", "")
        .add("2012-07-10 16:00:00",  -32767.0,  -32767.0, "0000003000000000", "")
        .add("2012-07-10 17:00:00",       4.8,       4.8, "0111000000100010", "")
        .add("2012-07-10 18:00:00",       5.7,       5.7, "0111000000100010", "")
        .add("2012-07-10 19:00:00",       5.1,       5.1, "0111000000100010", "")
        .add("2012-07-10 20:00:00",       4.5,       4.5, "0111000000100010", "")
        .add("2012-07-10 21:00:00",       4.4,       4.4, "0111000000100010", "")
        .add("2012-07-10 22:00:00",       4.0,       4.0, "0111000000100010", "")
        .add("2012-07-10 23:00:00",       3.4,       3.4, "0111000000100010", "")
        .add("2012-07-11 00:00:00",       3.4,       3.4, "0111000000100010", "");
    data.setStation(99765).setType(330)
        .add("2012-07-10 08:00:00",       5.4,       5.4, "0111000000100010", "")
        .add("2012-07-10 09:00:00",       4.8,       4.8, "0111000000100010", "")
        .add("2012-07-10 10:00:00",       5.6,       5.6, "0111000000100010", "")
        .add("2012-07-10 11:00:00",       5.6,       5.6, "0111000000100010", "")
        .add("2012-07-10 12:00:00",       7.6,       7.6, "0111000000100010", "")
        .add("2012-07-10 13:00:00",       6.3,       6.3, "0111000000100010", "")
        .add("2012-07-10 14:00:00",       5.2,       5.2, "0111000000100010", "")
        .add("2012-07-10 15:00:00",       4.9,       4.9, "0111000000100010", "")
        .add("2012-07-10 16:00:00",       4.8,       4.8, "0111000000100010", "")
        .add("2012-07-10 17:00:00",       4.0,       4.0, "0111000000100010", "")
        .add("2012-07-10 18:00:00",       4.0,       4.0, "0111000000100010", "")
        .add("2012-07-10 19:00:00",       4.0,       4.0, "0111000000100010", "")
        .add("2012-07-10 20:00:00",       4.2,       4.2, "0111000000100010", "")
        .add("2012-07-10 21:00:00",       4.1,       4.1, "0111000000100010", "")
        .add("2012-07-10 22:00:00",       3.8,       3.8, "0111000000100010", "")
        .add("2012-07-10 23:00:00",       3.4,       3.4, "0111000000100010", "")
        .add("2012-07-11 00:00:00",       2.8,       2.8, "0111000000100010", "");
    data.setStation(99760).setType(311);
    data.add("2012-07-10 08:00:00",       5.7,       5.7, "0111000000100010", "")
        .add("2012-07-10 09:00:00",       6.2,       6.2, "0111000000100010", "")
        .add("2012-07-10 09:20:00",       6.0,       6.0, "0111000000100010", "")
        .add("2012-07-10 10:00:00",       6.7,       6.7, "0111000000100010", "")
        .add("2012-07-10 10:50:00",       8.0,       8.0, "0111000000100010", "")
        .add("2012-07-10 11:00:00",       7.5,       7.5, "0111000000100010", "")
        .add("2012-07-10 11:50:00",       8.0,       8.0, "0111000000100010", "")
        .add("2012-07-10 12:00:00",       8.0,       8.0, "0111000000100010", "")
        .add("2012-07-10 13:00:00",       8.1,       8.1, "0111000000100010", "")
        .add("2012-07-10 13:20:00",       8.0,       8.0, "0111000000100010", "")
        .add("2012-07-10 13:50:00",       8.0,       8.0, "0111000000100010", "")
        .add("2012-07-10 14:00:00",       8.0,       8.0, "0111000000100010", "")
        .add("2012-07-10 15:00:00",       7.7,       7.7, "0111000000100010", "")
        .add("2012-07-10 16:00:00",       7.6,       7.6, "0111000000100010", "")
        .add("2012-07-10 17:00:00",       9.3,       9.3, "0111000000100010", "")
        .add("2012-07-10 18:00:00",       7.6,       7.6, "0111000000100010", "")
        .add("2012-07-10 19:00:00",       7.1,       7.1, "0111000000100010", "")
        .add("2012-07-10 20:00:00",       6.3,       6.3, "0111000000100010", "")
        .add("2012-07-10 21:00:00",       6.4,       6.4, "0111000000100010", "")
        .add("2012-07-10 22:00:00",       6.4,       6.4, "0111000000100010", "")
        .add("2012-07-10 23:00:00",       6.2,       6.2, "0111000000100010", "")
        .add("2012-07-11 00:00:00",       6.0,       6.0, "0111000000100010", "");
    data.setStation(99840).setType(311)
        .add("2012-07-10 08:00:00",       6.8,       6.8, "0111000000100010", "")
        .add("2012-07-10 08:50:00",       8.0,       8.0, "0111000000100010", "")
        .add("2012-07-10 09:00:00",       7.9,       7.9, "0111000000100010", "")
        .add("2012-07-10 09:50:00",       8.0,       8.0, "0111000000100010", "")
        .add("2012-07-10 10:00:00",       7.9,       7.9, "0111000000100010", "")
        .add("2012-07-10 10:50:00",       8.0,       8.0, "0111000000100010", "")
        .add("2012-07-10 11:00:00",       7.0,       7.0, "0111000000100010", "")
        .add("2012-07-10 11:50:00",       8.0,       8.0, "0111000000100010", "")
        .add("2012-07-10 12:00:00",       7.4,       7.4, "0111000000100010", "")
        .add("2012-07-10 12:50:00",       8.0,       8.0, "0111000000100010", "")
        .add("2012-07-10 13:00:00",       7.6,       7.6, "0111000000100010", "")
        .add("2012-07-10 13:50:00",       8.0,       8.0, "0113000000100010", "QC1-3b-211")
        .add("2012-07-10 14:00:00",       8.2,       8.2, "0111000000100010", "")
        .add("2012-07-10 14:50:00",       8.0,       8.0, "0113000000100010", "QC1-3b-211")
        .add("2012-07-10 15:00:00",       8.2,       8.2, "0111000000100010", "")
        .add("2012-07-10 15:50:00",       7.0,       7.0, "0111000000100010", "")
        .add("2012-07-10 16:00:00",       7.6,       7.6, "0111000000100010", "")
        .add("2012-07-10 16:50:00",       9.0,       9.0, "0111000000100010", "")
        .add("2012-07-10 17:00:00",       8.5,       8.5, "0111000000100010", "")
        .add("2012-07-10 17:50:00",       8.0,       8.0, "0111000000100010", "")
        .add("2012-07-10 18:00:00",       7.5,       7.5, "0111000000100010", "")
        .add("2012-07-10 18:50:00",       7.0,       7.0, "0111000000100010", "")
        .add("2012-07-10 19:00:00",       7.1,       7.1, "0111000000100010", "")
        .add("2012-07-10 19:50:00",       7.0,       7.0, "0111000000100010", "")
        .add("2012-07-10 20:00:00",       6.4,       6.4, "0111000000100010", "")
        .add("2012-07-10 20:50:00",       7.0,       7.0, "0111000000100010", "")
        .add("2012-07-10 21:00:00",       6.7,       6.7, "0111000000100010", "")
        .add("2012-07-10 21:50:00",       7.0,       7.0, "0111000000100010", "")
        .add("2012-07-10 22:00:00",       6.3,       6.3, "0111000000100010", "")
        .add("2012-07-10 22:50:00",       6.0,       6.0, "0111000000100010", "")
        .add("2012-07-10 23:00:00",       6.9,       6.9, "0111000000100010", "")
        .add("2012-07-10 23:50:00",       7.0,       7.0, "0111000000100010", "")
        .add("2012-07-11 00:00:00",       6.7,       6.7, "0111000000100010", "");
    ASSERT_NO_THROW(data.insert(db));

    std::ostringstream sql;
    sql << "INSERT INTO station VALUES(99752, 76.478, 16.549, 10.0, 0.0, 'S�RKAPP�YA', 1020, 99752, NULL, NULL, NULL, 0, 't', '2010-09-28 00:00:00');"
        << "INSERT INTO station VALUES(99754, 77.000, 15.500, 10.0, 0.0, 'HORNSUND', 1003, 99754, NULL, NULL, NULL, 8, 't', '1985-06-01 00:00:00');"
        << "INSERT INTO station VALUES(99765, 77.689, 14.784, 6.0, 0.0, 'AKSEL�YA', 1017, 99765, NULL, NULL, NULL, 8, 't', '2010-08-23 00:00:00');";

    INSERT_NEIGHBOR(sql, 99752, 211, 99754, -1.08172, 0.849429, 1.70314);
    INSERT_NEIGHBOR(sql, 99752, 211, 99765, -0.834066, 0.70727, 1.84426);

    INSERT_NEIGHBOR(sql, 99754, 211, 99760,  0.522852,  0.640886,  1.379930);
    INSERT_NEIGHBOR(sql, 99754, 211, 99765,  0.208712,  0.896689,  1.482840);
    INSERT_NEIGHBOR(sql, 99754, 211, 99840, -0.042242,  0.674842,  1.507970);
    INSERT_NEIGHBOR(sql, 99754, 211, 99752, -0.604032,  0.792897,  1.645490);
    INSERT_NEIGHBOR(sql, 99754, 211, 99737,  0.173956,  0.890109,  1.680210);

    ASSERT_NO_THROW(db->exec(sql.str()));

    std::stringstream config;
    config << "Start_YYYY = 2012\n"
           << "Start_MM   =    7\n"
           << "Start_DD   =   10\n"
           << "Start_hh   =   08\n"
           << "End_YYYY   = 2012\n"
           << "End_MM     =    7\n"
           << "End_DD     =   11\n"
           << "End_hh     =    0\n"
           << "TypeId     =  330\n"
           << "Parameter  = par=211,minPar=213,maxPar=215,minVal=-80,maxVal=80,offsetCorrectionLimit=15,fluctuationLevel=0.2\n";
    AlgorithmConfig params;
    ASSERT_PARSE_CONFIG(params, config);
    ASSERT_CONFIGURE(algo, params);

    const int N = 16;
    ASSERT_RUN(algo, bc, N);

    const double expectedI[N] = { 3.9,
                                  3.6, 3.9, 4.0, 4.2,
                                  3.3, 3.2,
                                  3.3, 3.3, 3.2, 3.1,
                                  3.3, 3.3, 3.3, 3.2,
                                  5.3 };
    const int expectedP[N] = { 211,
                               213, 213, 215, 215,
                               211, 211,
                               213, 213, 213, 213,
                               215, 215, 215, 215,
                               211 };
    const char* expectedTS[N] = { "2012-07-10 14:00:00",
                                  "2012-07-10 14:00:00", "2012-07-10 15:00:00", "2012-07-10 14:00:00", "2012-07-10 15:00:00",
                                  "2012-07-10 20:00:00", "2012-07-10 22:00:00",
                                  "2012-07-10 20:00:00", "2012-07-10 21:00:00", "2012-07-10 22:00:00", "2012-07-10 23:00:00",
                                  "2012-07-10 20:00:00", "2012-07-10 21:00:00", "2012-07-10 22:00:00", "2012-07-10 23:00:00",
                                  "2012-07-10 16:00:00" };
    const char* expectedCI[N] = { "0000001100000000",
                                  "0000001200000000", "0110000200000000", "0000001200000000", "0110000200000000",
                                  "0000001100000000", "0000001100000000",
                                  "0000001200000000", "0110000200000000", "0000001200000000", "0110000200000000",
                                  "0000001200000000", "0110000200000000", "0000001200000000", "0110000200000000",
                                  "0000001100000000" };
    for(int i=0; i<N; ++i) {
        EXPECT_NEAR(expectedI[i], bc->update(i).corrected(), 0.4) << "i=" << i;
        ASSERT_OBS_CONTROL_CFAILED(expectedTS[i], expectedCI[i], "QC2d-2-I", bc->update(i)) << "i=" << i;
        ASSERT_EQ(expectedP[i], bc->update(i).paramID()) << "i=" << i;
    }

    ASSERT_RUN(algo, bc, 0);
}
