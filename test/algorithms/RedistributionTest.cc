/* -*- c++ -*-
  Kvalobs - Free Quality Control Software for Meteorological Observations

  Copyright (C) 2011 met.no

  Contact information:
  Norwegian Meteorological Institute
  Postboks 43 Blindern
  N-0313 OSLO
  NORWAY
  email: kvalobs-dev@met.no

  This file is part of KVALOBS

  KVALOBS is free software; you can redistribute it and/or
  modify it under the terms of the GNU General Public License as
  published by the Free Software Foundation; either version 2
  of the License, or (at your option) any later version.

  KVALOBS is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  General Public License for more details.

  You should have received a copy of the GNU General Public License along
  with KVALOBS; if not, write to the Free Software Foundation Inc.,
  51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
*/

#define NEW_VERSION 1

#include "AlgorithmTestBase.h"
#include "algorithms/RedistributionAlgorithm.h"
#include "AlgorithmHelpers.h"
#include "Helpers.h"
#include "algorithms/tround.h"
#include "foreach.h"

#include <algorithm>
#include <numeric>

class RedistributionTest : public AlgorithmTestBase {
public:
    void SetUp();
    void TearDown();
    void Configure(ReadProgramOptions& params, int startDay, int endDay);
    void RoundingTest(const float* values, const float* expected, const int N);
protected:
    RedistributionAlgorithm2* algo;
};

void RedistributionTest::SetUp()
{
    AlgorithmTestBase::SetUp();
    algo = new RedistributionAlgorithm2();
    algo->setDatabase(db);
    algo->setBroadcaster(bc);

    std::ostringstream sql;
    sql << "INSERT INTO station VALUES(83880, 68.0645, 16.663,   3, 0, 'SØRFJORD KRAFTVERK', NULL, 83880, NULL, NULL, NULL, 10, 't', '1985-01-01 00:00:00');"
        << "INSERT INTO station VALUES(83520, 67.8977, 15.8673, 70, 0, 'TØMMERNESET',        NULL, 83520, NULL, NULL, NULL,  9, 't', '1985-07-01 00:00:00');"
        << "INSERT INTO station VALUES(84070, 68.3302, 16.7883, 53, 0, 'BJØRKÅSEN',          NULL, 84070, NULL, NULL, NULL, 10, 't', '1964-01-01 00:00:00');"
        << "INSERT INTO station VALUES(84190, 68.2082, 17.5157, 29, 0, 'SKJOMEN - STIBERG',  NULL, 84190, NULL, NULL, NULL,  9, 't', '1987-09-01 00:00:00');";

    sql << "INSERT INTO station_param VALUES(0, 110, 0, 0,   1, 365, -1, 'QC1-1-110', 'max;highest;high;low;lowest;min\n150;120.0;100.0;-1.0;-1.0;-1', NULL, '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0,   1, 365, -1, 'QC1-1-110x', '1;2;3;4;5;6\n-6999;-99.9;-99.8;999;6999;9999', '9999-VALUES', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 274, 304, -1, 'QC1-2-72.b4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 305, 334, -1, 'QC1-2-72.b4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 335, 365, -1, 'QC1-2-72.b4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0,   1,  31, -1, 'QC1-2-72.b4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0,  32,  59, -1, 'QC1-2-72.b4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0,  60,  90, -1, 'QC1-2-72.b4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0,  91, 120, -1, 'QC1-2-72.b4', 'R1\n5',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 121, 151, -1, 'QC1-2-72.b4', 'R1\n3',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 152, 181, -1, 'QC1-2-72.b4', 'R1\n1',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 182, 212, -1, 'QC1-2-72.b4', 'R1\n0',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 213, 243, -1, 'QC1-2-72.b4', 'R1\n0',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 244, 273, -1, 'QC1-2-72.b4', 'R1\n3',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 274, 304, -1, 'QC1-2-72.c4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 305, 334, -1, 'QC1-2-72.c4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 335, 365, -1, 'QC1-2-72.c4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0,   1,  31, -1, 'QC1-2-72.c4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0,  32,  59, -1, 'QC1-2-72.c4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0,  60,  90, -1, 'QC1-2-72.c4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0,  91, 120, -1, 'QC1-2-72.c4', 'R1\n5',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 121, 151, -1, 'QC1-2-72.c4', 'R1\n3',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 152, 181, -1, 'QC1-2-72.c4', 'R1\n1',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 182, 212, -1, 'QC1-2-72.c4', 'R1\n0',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 213, 243, -1, 'QC1-2-72.c4', 'R1\n0',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 244, 273, -1, 'QC1-2-72.c4', 'R1\n3',  '', '1500-01-01 00:00:00');";
    ASSERT_NO_THROW(db->exec(sql.str()));
}

void RedistributionTest::TearDown()
{
    delete algo;
    AlgorithmTestBase::TearDown();
}

void RedistributionTest::Configure(ReadProgramOptions& params, int startDay, int endDay)
{
    std::stringstream config;
    config << "Start_YYYY = 2011" << std::endl
           << "Start_MM   =   10" << std::endl
           << "Start_DD   =   " << startDay << std::endl
           << "Start_hh   =   06" << std::endl
           << "End_YYYY   = 2011" << std::endl
           << "End_MM     =   10" << std::endl
           << "End_DD     =   " << endDay << std::endl
           << "End_hh     =   06" << std::endl
           << "InterpCode=2"  << std::endl
           << "Step_DD=1"  << std::endl
           << "ParamId=110"  << std::endl
           << "TypeIds=302"  << std::endl
           << "TypeIds=402"  << std::endl
        // << "change_fmis=0->4"  << std::endl // FIXME this should probably be 4->0
           << "endpoint_cflags     = ___.__4.___.2__0" << std::endl
           << "missingpoint_cflags = ___.__3.___.2__0" << std::endl
           << "neighbor_cflags     = ___.___.___.1__." << std::endl
           << "neighbor_uflags     = __0.___.___.___." << std::endl
           << "before_uflags       = ___.___.___.___." << std::endl
           << "update_flagchange   = ___.___.___.7__.;___.__3.___.___.->___.__1.___.___.;___.__0.___.___.->___.__4.___.___." << std::endl
           << "InterpolationDistance=50.0"  << std::endl;
    params.Parse(config);
}

void RedistributionTest::RoundingTest(const float* values, const float* expected, const int N)
{
    const float rounded_acc = round<float,1>(std::accumulate(values, values+N, 0.0));

    float rounded_values[N];
    std::transform(values, values+N, rounded_values, round<float, 1>);
    const float acc_of_rounded = round<float,1>(std::accumulate(rounded_values, rounded_values+N, 0.0)), scaling = rounded_acc / acc_of_rounded;

    float interpolated_values[N];
    for(int i=0; i<N; ++i)
        interpolated_values[i] = round<float,1>(rounded_values[i] * scaling);
    const float acc_of_interpolated = round<float,1>(std::accumulate(interpolated_values, interpolated_values+N, 0.0));
    const float delta = acc_of_interpolated - rounded_acc;
    ASSERT_LE(0.05, fabs(delta)) << "values do not expose problem under test";

    std::ostringstream sql;
    sql // fake values assuming 0.075 mm for all stations
        << "INSERT INTO data VALUES (83880, '2011-10-13 06:00:00',    0.5, 110, '2011-10-28 15:40:00', 302, 0, 0,    0.5, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (83880, '2011-10-14 06:00:00', -32767, 110, '2011-10-28 15:40:00', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-15 06:00:00', -32767, 110, '2011-10-28 15:40:00', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-16 06:00:00', -32767, 110, '2011-10-28 15:40:00', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-17 06:00:00', -32767, 110, '2011-10-28 15:40:00', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-18 06:00:00', -32767, 110, '2011-10-28 15:40:00', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-19 06:00:00', " << rounded_acc << ", 110, '2011-10-28 15:40:00', 302, 0, 0, " << rounded_acc << ", '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"

        << "INSERT INTO data VALUES (83520, '2011-10-13 06:00:00',    0.5, 110, '2011-10-13 07:48:30', 302, 0, 0,    0.5, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-13 06:00:00',    0.1, 110, '2011-10-13 06:23:40', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');";

    for(int i=0; i<N; ++i) {
        const int d = 14 + i;
        const float r =rounded_values[i];
        sql << "INSERT INTO data VALUES (83520, '2011-10-" << d << " 06:00:00', " << r << ", 110, '2011-10-28 15:40:00', 302, 0, 0, " << r << ", '0110000000001000', '7000000000000000', '');"
            << "INSERT INTO data VALUES (84190, '2011-10-" << d << " 06:00:00', " << r << ", 110, '2011-10-28 15:40:00', 302, 0, 0, " << r << ", '0110000000001000', '7000000000000000', '');";
    }
    ASSERT_NO_THROW(db->exec(sql.str()));

    ReadProgramOptions params;
    Configure(params, 10, 19);

    algo->run(params);
    ASSERT_EQ(6, bc->count());

    float acc_of_corrected = 0;
    for(int i=0; i<bc->count(); ++i) {
        const kvalobs::kvData& d = bc->updates()[i];
        SCOPED_TRACE(testing::Message() << "Update #" << i);
        EXPECT_EQ(83880, d.stationID());
        EXPECT_FLOAT_EQ(expected[i], d.corrected()) << "aor=" << acc_of_rounded << " ra=" << rounded_acc << " v[" << i << "]=" << values[i] << " interp=" << interpolated_values[i];
        EXPECT_EQ(i==5 ? "0140004000007000" : "0000001000007000", d.controlinfo().flagstring());
        acc_of_corrected += d.corrected();
    }
    EXPECT_FLOAT_EQ(rounded_acc, acc_of_corrected);
}

TEST_F(RedistributionTest, Station83880History2011117)
{
    std::ostringstream sql;
    sql << "INSERT INTO data VALUES (83880, '2011-10-10 06:00:00',   16.9, 110, '2011-10-10 09:01:31', 302, 0, 0,   16.9, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-11 06:00:00',     -1, 110, '2011-10-11 06:03:01', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83880, '2011-10-12 06:00:00',    0.3, 110, '2011-10-12 05:11:04', 302, 0, 0,    0.3, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (83880, '2011-10-13 06:00:00',    6.5, 110, '2011-10-13 05:04:36', 302, 0, 0,    6.5, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (83880, '2011-10-14 06:00:00', -32767, 110, '2011-10-15 00:35:29', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-15 06:00:00', -32767, 110, '2011-10-16 00:35:40', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-16 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-17 06:00:00',   38.3, 110, '2011-10-17 09:11:19', 302, 0, 0,   38.3, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-18 06:00:00', -32767, 110, '2011-10-19 00:31:53', 302, 0, 0, -32767, '0000003000000000', '9999900000000000', '');"
        << "INSERT INTO data VALUES (83880, '2011-10-19 06:00:00',    0.6, 110, '2011-10-19 06:11:12', 302, 0, 0,    0.6, '0140000000000000', '7020400000000001', 'QC1-2-72.b12');"

        << "INSERT INTO data VALUES (83520, '2011-10-10 06:00:00',     -1, 110, '2011-10-10 06:23:45', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-11 06:00:00',     -1, 110, '2011-10-11 07:24:36', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-12 06:00:00',    0.1, 110, '2011-10-12 06:59:40', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-13 06:00:00',    2.5, 110, '2011-10-13 07:48:30', 302, 0, 0,    2.5, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-14 06:00:00',    2.6, 110, '2011-10-14 06:11:24', 302, 0, 0,    2.6, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-15 06:00:00',    5.7, 110, '2011-10-15 07:16:28', 302, 0, 0,    5.7, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-16 06:00:00',   54.2, 110, '2011-10-16 08:10:34', 302, 0, 0,   54.2, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-17 06:00:00',   11.4, 110, '2011-10-17 06:23:10', 302, 0, 0,   11.4, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-18 06:00:00',    6.7, 110, '2011-10-18 06:44:43', 302, 0, 0,    6.7, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-19 06:00:00',    0.7, 110, '2011-10-19 07:04:20', 302, 0, 0,    0.7, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84190, '2011-10-10 06:00:00',     -1, 110, '2011-10-10 06:59:47', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-11 06:00:00',     -1, 110, '2011-10-11 05:56:23', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-12 06:00:00',     -1, 110, '2011-10-12 06:16:56', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-13 06:00:00',    4.5, 110, '2011-10-13 06:23:40', 302, 0, 0,    4.5, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-14 06:00:00',    0.1, 110, '2011-10-14 06:05:03', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-15 06:00:00',    0.2, 110, '2011-10-16 15:13:23', 302, 0, 0,    0.2, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-16 06:00:00',    6.4, 110, '2011-10-16 15:13:23', 302, 0, 0,    6.4, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-17 06:00:00',      2, 110, '2011-10-17 06:19:35', 302, 0, 0,      2, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-18 06:00:00',    0.3, 110, '2011-10-18 05:41:31', 302, 0, 0,    0.3, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-19 06:00:00',    7.4, 110, '2011-10-19 06:36:28', 302, 0, 0,    7.4, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84070, '2011-10-10 06:00:00',     -1, 110, '2011-10-11 05:25:53', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-11 06:00:00',     -1, 110, '2011-10-11 05:25:53', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-12 06:00:00',     -1, 110, '2011-10-12 05:29:19', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-13 06:00:00',    2.1, 110, '2011-10-14 05:34:52', 302, 0, 0,    2.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-14 06:00:00',    0.6, 110, '2011-10-14 05:34:52', 302, 0, 0,    0.6, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-15 06:00:00', -32767, 110, '2011-10-16 00:36:09', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (84070, '2011-10-16 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (84070, '2011-10-17 06:00:00', -32767, 110, '2011-10-18 00:39:35', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (84070, '2011-10-18 06:00:00',   66.7, 110, '2011-10-19 06:43:04', 302, 0, 0,   66.7, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"
        << "INSERT INTO data VALUES (84070, '2011-10-19 06:00:00',    1.4, 110, '2011-10-19 06:43:04', 302, 0, 0,    1.4, '0110000000001000', '7000000000000000', '');";

        //<< "INSERT INTO data VALUES (83880, '2011-10-14 06:00:00', -32767, 110, '2011-10-15 00:35:29', 302, 0, 0, 0.9, '0000001000007000', '5896900000000000', 'QC1-7-110,QC2N_84070_83520_84190,QC2-redist');"
        //<< "INSERT INTO data VALUES (83880, '2011-10-15 06:00:00', -32767, 110, '2011-10-16 00:35:40', 302, 0, 0, 2.8, '0000001000007000', '5896900000000000', 'QC1-7-110,QC2N_83520_84190,QC2-redist');"
        //<< "INSERT INTO data VALUES (83880, '2011-10-16 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, 28.3, '0000001000007000', '5896900000000000', 'QC1-7-110,QC2N_83520_84190,QC2-redist');"
        //<< "INSERT INTO data VALUES (83880, '2011-10-17 06:00:00', 38.3, 110, '2011-10-17 09:11:19', 302, 0, 0, 6.3, '0140004000007000', '5336900000000001', 'QC1-2-72.b12,QC1-7-110,QC2N_83520_84190,QC2-redist');"
        /// << "INSERT INTO data VALUES (84070, '2011-10-10 06:00:00', 3.4, 110, '2011-10-10 12:41:17', 302, 0, 0, 3.4, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"
        /// << "INSERT INTO data VALUES (84070, '2011-10-10 06:00:00', 3.4, 110, '2011-10-10 12:41:17', 302, 0, 0, -1, '0140004000007000', '5336900000000001', 'QC1-2-72.b12,QC1-7-110,QC2N_84190,QC2-redist');"
    ASSERT_NO_THROW(db->exec(sql.str()));

    ReadProgramOptions params;
    Configure(params, 13, 17);

    algo->run(params);
    ASSERT_EQ(4, bc->count());

    const float expected_corrected[4] = { 0.9, 2.8, 28.3, 6.3 };
    const char* expected_controlinfo[4] = { "0000001000007000", "0000001000007000", "0000001000007000", "0140004000007000" };
    for(int i=0; i<bc->count(); ++i) {
        const kvalobs::kvData& d = bc->updates()[i];
        EXPECT_EQ(83880, d.stationID()) << " at index " << i;
        EXPECT_FLOAT_EQ(expected_corrected[i], d.corrected()) << " at index " << i;
        EXPECT_EQ(expected_controlinfo[i], d.controlinfo().flagstring()) << " at index " << i;
    }

    bc->clear();
    algo->run(params);
    ASSERT_EQ(0, bc->count());
}

TEST_F(RedistributionTest, SeriesPossiblyIncomplete)
{
    std::ostringstream sql;
    sql // some data are fake for stationid=83880
        << "INSERT INTO data VALUES (83880, '2011-10-10 06:00:00',   16.9, 110, '2011-10-10 09:01:31', 302, 0, 0,   16.9, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-11 06:00:00',     -1, 110, '2011-10-11 06:03:01', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83880, '2011-10-12 06:00:00',    0.3, 110, '2011-10-12 05:11:04', 302, 0, 0,    0.3, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (83880, '2011-10-13 06:00:00',    6.5, 110, '2011-10-13 05:04:36', 302, 0, 0,    6.5, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (83880, '2011-10-14 06:00:00',    6.3, 110, '2011-10-14 05:00:00', 302, 0, 0,    6.5, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (83880, '2011-10-15 06:00:00',    6.7, 110, '2011-10-15 05:00:00', 302, 0, 0,    6.5, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (83880, '2011-10-16 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-17 06:00:00',   12.8, 110, '2011-10-17 09:11:19', 302, 0, 0,   38.3, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-18 06:00:00', -32767, 110, '2011-10-19 00:31:53', 302, 0, 0, -32767, '0000003000000000', '9999900000000000', '');"
        << "INSERT INTO data VALUES (83880, '2011-10-19 06:00:00',    0.6, 110, '2011-10-19 06:11:12', 302, 0, 0,    0.6, '0140000000000000', '7020400000000001', 'QC1-2-72.b12');"

        << "INSERT INTO data VALUES (83520, '2011-10-10 06:00:00',     -1, 110, '2011-10-10 06:23:45', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-11 06:00:00',     -1, 110, '2011-10-11 07:24:36', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-12 06:00:00',    0.1, 110, '2011-10-12 06:59:40', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-13 06:00:00',    2.5, 110, '2011-10-13 07:48:30', 302, 0, 0,    2.5, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-14 06:00:00',    2.6, 110, '2011-10-14 06:11:24', 302, 0, 0,    2.6, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-15 06:00:00',    5.7, 110, '2011-10-15 07:16:28', 302, 0, 0,    5.7, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-16 06:00:00',   54.2, 110, '2011-10-16 08:10:34', 302, 0, 0,   54.2, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-17 06:00:00',   11.4, 110, '2011-10-17 06:23:10', 302, 0, 0,   11.4, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-18 06:00:00',    6.7, 110, '2011-10-18 06:44:43', 302, 0, 0,    6.7, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-19 06:00:00',    0.7, 110, '2011-10-19 07:04:20', 302, 0, 0,    0.7, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84190, '2011-10-10 06:00:00',     -1, 110, '2011-10-10 06:59:47', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-11 06:00:00',     -1, 110, '2011-10-11 05:56:23', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-12 06:00:00',     -1, 110, '2011-10-12 06:16:56', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-13 06:00:00',    4.5, 110, '2011-10-13 06:23:40', 302, 0, 0,    4.5, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-14 06:00:00',    0.1, 110, '2011-10-14 06:05:03', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-15 06:00:00',    0.2, 110, '2011-10-16 15:13:23', 302, 0, 0,    0.2, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-16 06:00:00',    6.4, 110, '2011-10-16 15:13:23', 302, 0, 0,    6.4, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-17 06:00:00',      2, 110, '2011-10-17 06:19:35', 302, 0, 0,      2, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-18 06:00:00',    0.3, 110, '2011-10-18 05:41:31', 302, 0, 0,    0.3, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-19 06:00:00',    7.4, 110, '2011-10-19 06:36:28', 302, 0, 0,    7.4, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84070, '2011-10-10 06:00:00',     -1, 110, '2011-10-11 05:25:53', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-11 06:00:00',     -1, 110, '2011-10-11 05:25:53', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-12 06:00:00',     -1, 110, '2011-10-12 05:29:19', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-13 06:00:00',    2.1, 110, '2011-10-14 05:34:52', 302, 0, 0,    2.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-14 06:00:00',    0.6, 110, '2011-10-14 05:34:52', 302, 0, 0,    0.6, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-15 06:00:00', -32767, 110, '2011-10-16 00:36:09', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (84070, '2011-10-16 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (84070, '2011-10-17 06:00:00', -32767, 110, '2011-10-18 00:39:35', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (84070, '2011-10-18 06:00:00',   66.7, 110, '2011-10-19 06:43:04', 302, 0, 0,   66.7, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"
        << "INSERT INTO data VALUES (84070, '2011-10-19 06:00:00',    1.4, 110, '2011-10-19 06:43:04', 302, 0, 0,    1.4, '0110000000001000', '7000000000000000', '');";
    ASSERT_NO_THROW(db->exec(sql.str()));

    ReadProgramOptions params;
    Configure(params, 16, 17);

    algo->run(params);
    ASSERT_EQ(0, bc->count());

    params.UT0 = "2011-10-15 06:00:00";
    algo->run(params);
    ASSERT_EQ(2, bc->count());
}

TEST_F(RedistributionTest, StartOfDatabase)
{
    // may not redistribute if first missing value is start of database
    std::ostringstream sql;
    sql // some data are fake for stationid=83880
        << "INSERT INTO data VALUES (83880, '2011-10-16 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-17 06:00:00',   12.8, 110, '2011-10-17 09:11:19', 302, 0, 0,   12.8, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-18 06:00:00',    0.6, 110, '2011-10-19 06:11:12', 302, 0, 0,    0.6, '0140000000000000', '7020400000000001', 'QC1-2-72.b12');"

        << "INSERT INTO data VALUES (83520, '2011-10-16 06:00:00',   54.2, 110, '2011-10-16 08:10:34', 302, 0, 0,   54.2, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-17 06:00:00',   11.4, 110, '2011-10-17 06:23:10', 302, 0, 0,   11.4, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-18 06:00:00',    6.7, 110, '2011-10-18 06:44:43', 302, 0, 0,    6.7, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84190, '2011-10-16 06:00:00',    6.4, 110, '2011-10-16 15:13:23', 302, 0, 0,    6.4, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-17 06:00:00',      2, 110, '2011-10-17 06:19:35', 302, 0, 0,      2, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-18 06:00:00',    0.3, 110, '2011-10-18 05:41:31', 302, 0, 0,    0.3, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84070, '2011-10-16 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (84070, '2011-10-17 06:00:00', -32767, 110, '2011-10-18 00:39:35', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (84070, '2011-10-18 06:00:00',   66.7, 110, '2011-10-19 06:43:04', 302, 0, 0,   66.7, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');";
    ASSERT_NO_THROW(db->exec(sql.str()));

    ReadProgramOptions params;
    Configure(params, 14, 17);

    algo->run(params);
    ASSERT_EQ(0, bc->count());

    sql.str("");
    sql << "INSERT INTO data VALUES (83880, '2011-10-15 06:00:00',   54.2, 110, '2011-10-16 08:10:34', 302, 0, 0,   54.2, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-15 06:00:00',   54.2, 110, '2011-10-16 08:10:34', 302, 0, 0,   54.2, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-15 06:00:00',   54.2, 110, '2011-10-16 08:10:34', 302, 0, 0,   54.2, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-15 06:00:00',   54.2, 110, '2011-10-16 08:10:34', 302, 0, 0,   54.2, '0110000000001000', '7000000000000000', '');";
    ASSERT_NO_THROW(db->exec(sql.str()));

    algo->run(params);
    ASSERT_EQ(2, bc->count());
}

TEST_F(RedistributionTest, TwoSeries)
{
    // redistribute twice if there are two accumulations
    std::ostringstream sql;
    sql // some data are fake
        << "INSERT INTO data VALUES (83880, '2011-10-10 06:00:00',   16.9, 110, '2011-10-10 09:01:31', 302, 0, 0,   16.9, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-11 06:00:00',     -1, 110, '2011-10-11 06:03:01', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83880, '2011-10-12 06:00:00',    0.3, 110, '2011-10-12 05:11:04', 302, 0, 0,    0.3, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (83880, '2011-10-13 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-14 06:00:00',   12.8, 110, '2011-10-17 09:11:19', 302, 0, 0,   38.3, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-15 06:00:00',    6.5, 110, '2011-10-13 05:04:36', 302, 0, 0,    6.5, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (83880, '2011-10-16 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-17 06:00:00',   12.8, 110, '2011-10-17 09:11:19', 302, 0, 0,   38.3, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-18 06:00:00', -32767, 110, '2011-10-19 00:31:53', 302, 0, 0, -32767, '0000003000000000', '9999900000000000', '');"
        << "INSERT INTO data VALUES (83880, '2011-10-19 06:00:00',    0.6, 110, '2011-10-19 06:11:12', 302, 0, 0,    0.6, '0140000000000000', '7020400000000001', 'QC1-2-72.b12');"

        << "INSERT INTO data VALUES (83520, '2011-10-10 06:00:00',     -1, 110, '2011-10-10 06:23:45', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-11 06:00:00',     -1, 110, '2011-10-11 07:24:36', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-12 06:00:00',    0.1, 110, '2011-10-12 06:59:40', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-13 06:00:00',    2.5, 110, '2011-10-13 07:48:30', 302, 0, 0,    2.5, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-14 06:00:00',    2.6, 110, '2011-10-14 06:11:24', 302, 0, 0,    2.6, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-15 06:00:00',    5.7, 110, '2011-10-15 07:16:28', 302, 0, 0,    5.7, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-16 06:00:00',   54.2, 110, '2011-10-16 08:10:34', 302, 0, 0,   54.2, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-17 06:00:00',   11.4, 110, '2011-10-17 06:23:10', 302, 0, 0,   11.4, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-18 06:00:00',    6.7, 110, '2011-10-18 06:44:43', 302, 0, 0,    6.7, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-19 06:00:00',    0.7, 110, '2011-10-19 07:04:20', 302, 0, 0,    0.7, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84190, '2011-10-10 06:00:00',     -1, 110, '2011-10-10 06:59:47', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-11 06:00:00',     -1, 110, '2011-10-11 05:56:23', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-12 06:00:00',     -1, 110, '2011-10-12 06:16:56', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-13 06:00:00',    4.5, 110, '2011-10-13 06:23:40', 302, 0, 0,    4.5, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-14 06:00:00',    0.1, 110, '2011-10-14 06:05:03', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-15 06:00:00',    0.2, 110, '2011-10-16 15:13:23', 302, 0, 0,    0.2, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-16 06:00:00',    6.4, 110, '2011-10-16 15:13:23', 302, 0, 0,    6.4, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-17 06:00:00',      2, 110, '2011-10-17 06:19:35', 302, 0, 0,      2, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-18 06:00:00',    0.3, 110, '2011-10-18 05:41:31', 302, 0, 0,    0.3, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-19 06:00:00',    7.4, 110, '2011-10-19 06:36:28', 302, 0, 0,    7.4, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84070, '2011-10-10 06:00:00',     -1, 110, '2011-10-11 05:25:53', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-11 06:00:00',     -1, 110, '2011-10-11 05:25:53', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-12 06:00:00',     -1, 110, '2011-10-12 05:29:19', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-13 06:00:00',    2.1, 110, '2011-10-14 05:34:52', 302, 0, 0,    2.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-14 06:00:00',    0.6, 110, '2011-10-14 05:34:52', 302, 0, 0,    0.6, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-15 06:00:00',   1.00, 110, '2011-10-14 05:34:52', 302, 0, 0,   1.00, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-16 06:00:00',   1.00, 110, '2011-10-14 05:34:52', 302, 0, 0,   1.00, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-17 06:00:00',   1.00, 110, '2011-10-14 05:34:52', 302, 0, 0,   1.00, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-18 06:00:00',   1.00, 110, '2011-10-14 05:34:52', 302, 0, 0,   1.00, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-19 06:00:00',    1.4, 110, '2011-10-19 06:43:04', 302, 0, 0,    1.4, '0110000000001000', '7000000000000000', '');";
    ASSERT_NO_THROW(db->exec(sql.str()));

    ReadProgramOptions params;
    Configure(params, 11, 18);

    algo->run(params);
    ASSERT_EQ(4, bc->count());

    const float expected_corrected[4] = { 9.4, 3.4, 10.3, 2.5 };
    const char* expected_controlinfo[4] = { "0000001000007000", "0140004000007000", "0000001000007000", "0140004000007000" };
    const miutil::miTime expected_obstime[4] = { "2011-10-13 06:00:00", "2011-10-14 06:00:00", "2011-10-16 06:00:00", "2011-10-17 06:00:00" };
    for(int i=0; i<bc->count(); ++i) {
        const kvalobs::kvData& d = bc->updates()[i];
        SCOPED_TRACE(testing::Message() << "Update #" << i);
        EXPECT_EQ(83880, d.stationID());
        EXPECT_FLOAT_EQ(expected_corrected[i], d.corrected());
        EXPECT_EQ(expected_controlinfo[i], d.controlinfo().flagstring());
        EXPECT_EQ(expected_obstime[i], d.obstime());
    }
}

TEST_F(RedistributionTest, OneOfTwoTypeids)
{
    // may only redistribute among same typeid
    std::ostringstream sql;
    sql // first station has other typeid
        << "INSERT INTO data VALUES (83880, '2011-10-12 06:00:00',    0.3, 110, '2011-10-12 05:11:04', 302, 0, 0,    0.3, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (83880, '2011-10-13 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-14 06:00:00',   12.8, 110, '2011-10-17 09:11:19', 302, 0, 0,   12.8, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"

        << "INSERT INTO data VALUES (83520, '2011-10-12 06:00:00',    0.1, 110, '2011-10-12 06:59:40', 402, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-13 06:00:00',    2.5, 110, '2011-10-13 07:48:30', 402, 0, 0,    2.5, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-14 06:00:00',    2.6, 110, '2011-10-14 06:11:24', 402, 0, 0,    2.6, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84190, '2011-10-12 06:00:00',     -1, 110, '2011-10-12 06:16:56', 402, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-13 06:00:00',    4.5, 110, '2011-10-13 06:23:40', 402, 0, 0,    4.5, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-14 06:00:00',    0.1, 110, '2011-10-14 06:05:03', 402, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84070, '2011-10-12 06:00:00',    0.3, 110, '2011-10-12 05:11:04', 402, 0, 0,    0.3, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (84070, '2011-10-13 06:00:00', -32767, 110, '2011-10-17 00:30:56', 402, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (84070, '2011-10-14 06:00:00',     10, 110, '2011-10-17 09:11:19', 402, 0, 0,     10, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');";
    ASSERT_NO_THROW(db->exec(sql.str()));

    ReadProgramOptions params;
    Configure(params, 11, 18);

    algo->run(params);
    ASSERT_EQ(2, bc->count());

    const float expected_corrected[2] = { 9.8, 0.2 };
    const char* expected_controlinfo[2] = { "0000001000007000", "0140004000007000" };
    const miutil::miTime expected_obstime[2] = { "2011-10-13 06:00:00", "2011-10-14 06:00:00" };
    for(int i=0; i<bc->count(); ++i) {
        const kvalobs::kvData& d = bc->updates()[i];
        SCOPED_TRACE(testing::Message() << "Update #" << i);
        EXPECT_EQ(84070, d.stationID());
        EXPECT_FLOAT_EQ(expected_corrected[i], d.corrected());
        EXPECT_EQ(expected_controlinfo[i], d.controlinfo().flagstring());
        EXPECT_EQ(expected_obstime[i], d.obstime());
    }
}

TEST_F(RedistributionTest, NoGoodNeighbors)
{
    // may not redistribute if there are no neighbors with good data
    std::ostringstream sql;
    sql << "INSERT INTO data VALUES (83880, '2011-10-12 06:00:00',    0.3, 110, '2011-10-12 05:11:04', 302, 0, 0,    0.3, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (83880, '2011-10-13 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-14 06:00:00',   12.8, 110, '2011-10-17 09:11:19', 302, 0, 0,   12.8, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"

        << "INSERT INTO data VALUES (83520, '2011-10-12 06:00:00',    0.1, 110, '2011-10-12 06:59:40', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-13 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83520, '2011-10-14 06:00:00',    2.6, 110, '2011-10-14 06:11:24', 302, 0, 0,    2.6, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84190, '2011-10-12 06:00:00',     -1, 110, '2011-10-12 06:16:56', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-13 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (84190, '2011-10-14 06:00:00',    0.1, 110, '2011-10-14 06:05:03', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');";
    ASSERT_NO_THROW(db->exec(sql.str()));

    ReadProgramOptions params;
    Configure(params, 11, 18);

    algo->run(params);
    ASSERT_EQ(0, bc->count());

    sql.str("");
    sql << "UPDATE data SET original = 1.0, corrected = 1.0, controlinfo = '0110000000001000', useinfo='7000000000000000', cfailed='' WHERE stationid IN (83520, 84190) AND obstime = '2011-10-13 06:00:00';";
    ASSERT_NO_THROW(db->exec(sql.str()));

    algo->run(params);
    ASSERT_EQ(2, bc->count());
}

TEST_F(RedistributionTest, NoGoodNeighborsForOnePoint)
{
    // may not redistribute if for one point in the time series, there are no neighbors
    std::ostringstream sql;
    sql << "INSERT INTO data VALUES (83880, '2011-10-11 06:00:00',    0.3, 110, '2011-10-12 05:11:04', 302, 0, 0,    0.3, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (83880, '2011-10-12 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-13 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-14 06:00:00',   12.8, 110, '2011-10-17 09:11:19', 302, 0, 0,   12.8, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"

        << "INSERT INTO data VALUES (83520, '2011-10-11 06:00:00',    0.1, 110, '2011-10-12 06:59:40', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-12 06:00:00',    0.2, 110, '2011-10-12 06:59:40', 302, 0, 0,    0.2, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-13 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83520, '2011-10-14 06:00:00',    2.6, 110, '2011-10-14 06:11:24', 302, 0, 0,    2.6, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84190, '2011-10-11 06:00:00',     -1, 110, '2011-10-12 06:16:56', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-12 06:00:00',    0.1, 110, '2011-10-12 06:16:56', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-13 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (84190, '2011-10-14 06:00:00',    0.1, 110, '2011-10-14 06:05:03', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84070, '2011-10-11 06:00:00',    0.3, 110, '2011-10-12 05:11:04', 302, 0, 0,    0.3, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (84070, '2011-10-12 06:00:00',    0.4, 110, '2011-10-12 05:11:04', 302, 0, 0,    0.4, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (84070, '2011-10-13 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (84070, '2011-10-14 06:00:00',     10, 110, '2011-10-17 09:11:19', 302, 0, 0,     10, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');";
    ASSERT_NO_THROW(db->exec(sql.str()));

    ReadProgramOptions params;
    Configure(params, 11, 18);

    algo->run(params);
    ASSERT_EQ(0, bc->count());

    sql.str("");
    sql << "UPDATE data SET original = 1.0, corrected = 1.0, controlinfo = '0110000000001000', useinfo='7000000000000000', cfailed='' WHERE stationid IN (83520, 84190, 84070) AND obstime = '2011-10-13 06:00:00';";
    ASSERT_NO_THROW(db->exec(sql.str()));

    algo->run(params);
    ASSERT_EQ(3, bc->count());
}

TEST_F(RedistributionTest, NeighborsTooFar)
{
    // may not redistribute if for one point in the time series, there are no neighbors
    std::ostringstream sql;
    sql // first station has other typeid
        << "INSERT INTO data VALUES (83880, '2011-10-12 06:00:00',    0.3, 110, '2011-10-12 05:11:04', 302, 0, 0,    0.3, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (83880, '2011-10-13 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-14 06:00:00',   12.8, 110, '2011-10-17 09:11:19', 302, 0, 0,   12.8, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"

        << "INSERT INTO data VALUES (83520, '2011-10-12 06:00:00',    0.1, 110, '2011-10-12 06:59:40', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-13 06:00:00',    2.5, 110, '2011-10-13 07:48:30', 302, 0, 0,    2.5, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-14 06:00:00',    2.6, 110, '2011-10-14 06:11:24', 302, 0, 0,    2.6, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84190, '2011-10-12 06:00:00',     -1, 110, '2011-10-12 06:16:56', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-13 06:00:00',    4.5, 110, '2011-10-13 06:23:40', 302, 0, 0,    4.5, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-14 06:00:00',    0.1, 110, '2011-10-14 06:05:03', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84070, '2011-10-12 06:00:00',    0.3, 110, '2011-10-12 05:11:04', 302, 0, 0,    0.3, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (84070, '2011-10-13 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (84070, '2011-10-14 06:00:00',     10, 110, '2011-10-17 09:11:19', 302, 0, 0,     10, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');";
    ASSERT_NO_THROW(db->exec(sql.str()));

    ReadProgramOptions params;
    Configure(params, 11, 18);
    params.InterpolationLimit = 5; // only neighbors within 5 km => none

    algo->run(params);
    ASSERT_EQ(0, bc->count());

    params.InterpolationLimit = 50;
    algo->run(params);
    ASSERT_EQ(4, bc->count());
}

TEST_F(RedistributionTest, BoneDry)
{
    // check correct redistribution of -1 values
    std::ostringstream sql;
    sql // first station has other typeid
        << "INSERT INTO data VALUES (83880, '2011-10-12 06:00:00',    0.3, 110, '2011-10-12 05:11:04', 302, 0, 0,    0.3, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (83880, '2011-10-13 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-14 06:00:00',    0.1, 110, '2011-10-17 09:11:19', 302, 0, 0,    0.1, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"

        << "INSERT INTO data VALUES (83520, '2011-10-12 06:00:00',    0.1, 110, '2011-10-12 06:59:40', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-13 06:00:00',     -1, 110, '2011-10-13 07:48:30', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-14 06:00:00',     -1, 110, '2011-10-14 06:11:24', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84190, '2011-10-12 06:00:00',     -1, 110, '2011-10-12 06:16:56', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-13 06:00:00',    0.0, 110, '2011-10-13 06:23:40', 302, 0, 0,    0.0, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-14 06:00:00',    0.1, 110, '2011-10-14 06:05:03', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84070, '2011-10-12 06:00:00',    0.1, 110, '2011-10-12 06:16:56', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-13 06:00:00',     -1, 110, '2011-10-13 06:23:40', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-14 06:00:00',    0.0, 110, '2011-10-14 06:05:03', 302, 0, 0,    0.0, '0110000000001000', '7000000000000000', '');";
    ASSERT_NO_THROW(db->exec(sql.str()));

    ReadProgramOptions params;
    Configure(params, 11, 18);

    algo->run(params);
    ASSERT_EQ(2, bc->count());

    const float expected_corrected[2] = { -1, 0.1 };
    const char* expected_controlinfo[2] = { "0000001000007000", "0140004000007000" };
    const miutil::miTime expected_obstime[2] = { "2011-10-13 06:00:00", "2011-10-14 06:00:00" };
    for(int i=0; i<bc->count(); ++i) {
        const kvalobs::kvData& d = bc->updates()[i];
        SCOPED_TRACE(testing::Message() << "Update #" << i);
        EXPECT_EQ(83880, d.stationID());
        EXPECT_FLOAT_EQ(expected_corrected[i], d.corrected());
        EXPECT_EQ(expected_controlinfo[i], d.controlinfo().flagstring());
        EXPECT_EQ(expected_obstime[i], d.obstime());
    }
}

TEST_F(RedistributionTest, IncompleteSeries)
{
    // may not redistribute if no accumulated value yet
    std::ostringstream sql;
    sql << "INSERT INTO data VALUES (83880, '2011-10-12 06:00:00',    0.3, 110, '2011-10-12 05:11:04', 302, 0, 0,    0.3, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (83880, '2011-10-13 06:00:00',    6.5, 110, '2011-10-13 05:04:36', 302, 0, 0,    6.5, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (83880, '2011-10-14 06:00:00', -32767, 110, '2011-10-15 00:35:29', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-15 06:00:00', -32767, 110, '2011-10-16 00:35:40', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-16 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"

        << "INSERT INTO data VALUES (83520, '2011-10-12 06:00:00',    0.1, 110, '2011-10-12 06:59:40', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-13 06:00:00',    2.5, 110, '2011-10-13 07:48:30', 302, 0, 0,    2.5, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-14 06:00:00',    2.6, 110, '2011-10-14 06:11:24', 302, 0, 0,    2.6, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-15 06:00:00',    5.7, 110, '2011-10-15 07:16:28', 302, 0, 0,    5.7, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-16 06:00:00',   54.2, 110, '2011-10-16 08:10:34', 302, 0, 0,   54.2, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84190, '2011-10-12 06:00:00',     -1, 110, '2011-10-12 06:16:56', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-13 06:00:00',    4.5, 110, '2011-10-13 06:23:40', 302, 0, 0,    4.5, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-14 06:00:00',    0.1, 110, '2011-10-14 06:05:03', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-15 06:00:00',    0.2, 110, '2011-10-16 15:13:23', 302, 0, 0,    0.2, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-16 06:00:00',    6.4, 110, '2011-10-16 15:13:23', 302, 0, 0,    6.4, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84070, '2011-10-12 06:00:00',     -1, 110, '2011-10-12 05:29:19', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-13 06:00:00',    2.1, 110, '2011-10-14 05:34:52', 302, 0, 0,    2.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-14 06:00:00',    0.6, 110, '2011-10-14 05:34:52', 302, 0, 0,    0.6, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-15 06:00:00', -32767, 110, '2011-10-16 00:36:09', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (84070, '2011-10-16 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');";
    ASSERT_NO_THROW(db->exec(sql.str()));

    ReadProgramOptions params;
    Configure(params, 10, 17);

    algo->run(params);
    ASSERT_EQ(0, bc->count());

    sql.str("");
    sql << "INSERT INTO data VALUES (83880, '2011-10-17 06:00:00',   12.8, 110, '2011-10-17 09:11:19', 302, 0, 0,   12.8, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"
        << "INSERT INTO data VALUES (83520, '2011-10-17 06:00:00',    8.2, 110, '2011-10-16 08:10:34', 302, 0, 0,    8.2, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-17 06:00:00',    2.4, 110, '2011-10-16 15:13:23', 302, 0, 0,    2.4, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-17 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');";
    ASSERT_NO_THROW(db->exec(sql.str()));

    algo->run(params);
    ASSERT_EQ(4, bc->count());
}

TEST_F(RedistributionTest, Release113)
{
    // origin of test case: https://kvalobs.wiki.met.no/doku.php?id=kvoss:system:qc2:user:version:kvqc2d-1.1.3
    std::ostringstream sql;
    sql << "INSERT INTO data VALUES (66100, '2011-05-05 06:00:00',    5.8, 110, '2011-05-10 14:35:42', 402, 0, 0,    5.8, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (66100, '2011-05-06 06:00:00',    0.9, 110, '2011-05-10 14:35:42', 402, 0, 0,    0.9, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (66100, '2011-05-07 06:00:00', -32767, 110, '2011-05-24 19:21:18', 402, 0, 0, -32767, '0000003000000000', '7899900000000000', '');"
        << "INSERT INTO data VALUES (66100, '2011-05-08 06:00:00', -32767, 110, '2011-05-24 19:21:18', 402, 0, 0, -32767, '0000003000000000', '7899900000000000', '');"
        << "INSERT INTO data VALUES (66100, '2011-05-09 06:00:00', -32767, 110, '2011-05-24 19:21:18', 402, 0, 0, -32767, '0000003000000000', '7899900000000000', '');"
        << "INSERT INTO data VALUES (66100, '2011-05-10 06:00:00', -32767, 110, '2011-05-24 19:21:18', 402, 0, 0, -32767, '0000003000000000', '7899900000000000', '');"
        << "INSERT INTO data VALUES (66100, '2011-05-11 06:00:00', -32767, 110, '2011-05-24 19:21:18', 402, 0, 0, -32767, '0000003000000000', '7899900000000000', '');"
        << "INSERT INTO data VALUES (66100, '2011-05-12 06:00:00', -32767, 110, '2011-05-24 19:21:18', 402, 0, 0, -32767, '0000003000000000', '7899900000000000', '');"
        << "INSERT INTO data VALUES (66100, '2011-05-13 06:00:00', -32767, 110, '2011-05-24 19:21:18', 402, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110b');"
        << "INSERT INTO data VALUES (66100, '2011-05-14 06:00:00', -32767, 110, '2011-05-24 19:21:18', 402, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110b');"
        << "INSERT INTO data VALUES (66100, '2011-05-15 06:00:00', -32767, 110, '2011-05-24 19:21:18', 402, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110b');"
        << "INSERT INTO data VALUES (66100, '2011-05-16 06:00:00',   27.1, 110, '2011-05-24 19:21:18', 402, 0, 0,   27.1, '0140004000002000', '7330900000000001', 'QC1-7-110b');";

    // fake, did not find actual data for stations 66070 and 65270
    const int neighbors[4] = { 65270, 66070, 67150, 68270 };
    for(int d=5; d<=16; ++d) {
        for(int j=0; j<4; ++j) {
            const int n = neighbors[j];
            sql << "INSERT INTO data VALUES (" << n << ", '2011-05-" << std::setw(2) << std::setfill('0') << d << " 06:00:00', 2.7, 110, '2011-10-28 15:40:00', 402, 0, 0, 2.7, '0110000000001000', '7000000000000000', '');";
        }
    }

    sql << "INSERT INTO station VALUES(65270,  63.2302,  9.3488, 306, 0,                'S_VATNET', NULL, 65270, NULL, NULL, NULL,  9, 't', '1965-07-01 00:00:00');"
        << "INSERT INTO station VALUES(66070,  63.2941,  9.7291,  84, 0, 'SKJENALDFOSSEN I ORKDAL', NULL, 66070, NULL, NULL, NULL,  9, 't', '1907-01-01 00:00:00');"
        << "INSERT INTO station VALUES(66100, 63.33085,  9.6489, 300, 0,                  'SONGLI', NULL, 66100, NULL, NULL, NULL, 10, 't', '1988-07-03 00:00:00');"
        << "INSERT INTO station VALUES(67150,   63.328, 10.2737,  13, 0,              'LEINSTRAND', NULL, 67150, NULL, NULL, NULL,  9, 't', '1960-01-01 00:00:00');"
        << "INSERT INTO station VALUES(68270,  63.2315, 10.4369, 173, 0,                 'L_KSMYR', NULL, 68270, NULL, NULL, NULL,  9, 't', '1960-01-01 00:00:00');"

        << "INSERT INTO station_param VALUES(0, 110, 0, 0,   1, 365, -1,   'QC1-1-110', 'max;highest;high;low;lowest;min\n150;120.0;100.0;-1.0;-1.0;-1',          NULL, '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 274, 304, -1, 'QC1-2-72.b4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 305, 334, -1, 'QC1-2-72.b4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 335, 365, -1, 'QC1-2-72.b4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0,   1,  31, -1, 'QC1-2-72.b4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0,  32,  59, -1, 'QC1-2-72.b4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0,  60,  90, -1, 'QC1-2-72.b4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0,  91, 120, -1, 'QC1-2-72.b4', 'R1\n5',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 121, 151, -1, 'QC1-2-72.b4', 'R1\n3',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 152, 181, -1, 'QC1-2-72.b4', 'R1\n1',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 182, 212, -1, 'QC1-2-72.b4', 'R1\n0',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 213, 243, -1, 'QC1-2-72.b4', 'R1\n0',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 244, 273, -1, 'QC1-2-72.b4', 'R1\n3',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 274, 304, -1, 'QC1-2-72.c4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 305, 334, -1, 'QC1-2-72.c4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 335, 365, -1, 'QC1-2-72.c4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0,   1,  31, -1, 'QC1-2-72.c4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0,  32,  59, -1, 'QC1-2-72.c4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0,  60,  90, -1, 'QC1-2-72.c4', 'R1\n10', '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0,  91, 120, -1, 'QC1-2-72.c4', 'R1\n5',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 121, 151, -1, 'QC1-2-72.c4', 'R1\n3',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 152, 181, -1, 'QC1-2-72.c4', 'R1\n1',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 182, 212, -1, 'QC1-2-72.c4', 'R1\n0',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 213, 243, -1, 'QC1-2-72.c4', 'R1\n0',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0, 244, 273, -1, 'QC1-2-72.c4', 'R1\n3',  '', '1500-01-01 00:00:00');"
        << "INSERT INTO station_param VALUES(0, 110, 0, 0,   1, 365, -1, 'QC1-1-110x',  '1;2;3;4;5;6\n-6999;-99.9;-99.8;999;6999;9999', '9999-VALUES', '1500-01-01 00:00:00');";
    ASSERT_NO_THROW(db->exec(sql.str()));

    ReadProgramOptions params;
    Configure(params, 5, 16);
    params.UT0 = "2011-05-05 06:00:00";
    params.UT1 = "2011-05-16 06:00:00";

    // with bad fd flags, make sure that the redistribution does not run
    algo->run(params);
    ASSERT_EQ(0, bc->count());

    // now fix the fd flags and make sure that the redistribution runs
    sql.str("");
    sql << "UPDATE data SET controlinfo = '0000003000002000' WHERE stationid = 66100 AND obstime BETWEEN '2011-05-07 06:00:00' AND '2011-05-12 06:00:00';";
    ASSERT_NO_THROW(db->exec(sql.str()));

    algo->run(params);
    ASSERT_EQ(10, bc->count());
}

// TEST_F(RedistributionTest, RerunWithUpdatedValues)
// {
//     FAIL() << "test not implemented";
// }
// 
// TEST_F(RedistributionTest, Bugzilla1296)
// {
//     FAIL() << "test not implemented";
// }
// 
// TEST_F(RedistributionTest, Bugzilla1304)
// {
//     // by default assume dry
//     FAIL() << "test not implemented";
// }
// 
// TEST_F(RedistributionTest, Bugzilla1322)
// {
//     // redistribution run starts in the middle of a sequence of missing values
//     FAIL() << "test not implemented, no example data found";
// }

TEST_F(RedistributionTest, Bugzilla1325)
{
    // consistency of accumulated value with sum of redistributed values
    const int N = 6;
    const float values[N]   = { 1.07, 2.07, 3.07, 2.07, 1.07, 1.07 };
    const float expected[N] = { 1.0,  2.1,  3.0,  2.1,  1.1,  1.1 };

    RoundingTest(values, expected, N);
}

TEST_F(RedistributionTest, Bugzilla1325Comment4)
{
    const int N = 6;
    const float values[N]   = { 0.07, 0.17, 0.17, 0.17, 0.17, 0.07 };
    const float expected[N] = { 0.0,  0.1,  0.2,  0.2,  0.2,  0.1 };

    RoundingTest(values, expected, N);
}

TEST_F(RedistributionTest, RoundingForVerySmallValues)
{
    // keep sum of distributed values identical to accumulated value; see bugzilla 1325
    const int N = 6;
    const float values[N]   = { 0.07, 0.07, 0.07, 0.07, 0.07, 0.07 };
    const float expected[N] = { 0.0,  0.0,  0.1,  0.1,  0.1,  0.1 };

    RoundingTest(values, expected, N);
}

TEST_F(RedistributionTest, Bugzilla1333)
{
    std::ostringstream sql;
    sql // some data are fake for stationid=83880
        << "INSERT INTO data VALUES (83880, '2011-10-10 06:00:00',   16.9, 110, '2011-10-10 09:01:31', 302, 0, 0,   16.9, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-11 06:00:00',     -1, 110, '2011-10-11 06:03:01', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83880, '2011-10-12 06:00:00',    0.3, 110, '2011-10-12 05:11:04', 302, 0, 0,    0.3, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (83880, '2011-10-13 06:00:00',    6.5, 110, '2011-10-13 05:04:36', 302, 0, 0,    6.5, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (83880, '2011-10-14 06:00:00',    6.3, 110, '2011-10-14 05:00:00', 302, 0, 0,    6.5, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (83880, '2011-10-15 06:00:00',    6.7, 110, '2011-10-15 05:00:00', 302, 0, 0,    6.5, '0140000000001000', '7020400000000001', 'QC1-2-72.b12');"
        << "INSERT INTO data VALUES (83880, '2011-10-16 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-17 06:00:00',   12.8, 110, '2011-10-17 09:11:19', 302, 0, 0,   38.3, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"
        << "INSERT INTO data VALUES (83880, '2011-10-18 06:00:00', -32767, 110, '2011-10-19 00:31:53', 302, 0, 0, -32767, '0000003000000000', '9999900000000000', '');"
        << "INSERT INTO data VALUES (83880, '2011-10-19 06:00:00',    0.6, 110, '2011-10-19 06:11:12', 302, 0, 0,    0.6, '0140000000000000', '7020400000000001', 'QC1-2-72.b12');"

        << "INSERT INTO data VALUES (83520, '2011-10-10 06:00:00',     -1, 110, '2011-10-10 06:23:45', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-11 06:00:00',     -1, 110, '2011-10-11 07:24:36', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-12 06:00:00',    0.1, 110, '2011-10-12 06:59:40', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-13 06:00:00',    2.5, 110, '2011-10-13 07:48:30', 302, 0, 0,    2.5, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-14 06:00:00',    2.6, 110, '2011-10-14 06:11:24', 302, 0, 0,    2.6, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-15 06:00:00',    5.7, 110, '2011-10-15 07:16:28', 302, 0, 0,    5.7, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-16 06:00:00',   54.2, 110, '2011-10-16 08:10:34', 302, 0, 0,   54.2, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-17 06:00:00',   11.4, 110, '2011-10-17 06:23:10', 302, 0, 0,   11.4, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-18 06:00:00',    6.7, 110, '2011-10-18 06:44:43', 302, 0, 0,    6.7, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (83520, '2011-10-19 06:00:00',    0.7, 110, '2011-10-19 07:04:20', 302, 0, 0,    0.7, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84190, '2011-10-10 06:00:00',     -1, 110, '2011-10-10 06:59:47', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-11 06:00:00',     -1, 110, '2011-10-11 05:56:23', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-12 06:00:00',     -1, 110, '2011-10-12 06:16:56', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-13 06:00:00',    4.5, 110, '2011-10-13 06:23:40', 302, 0, 0,    4.5, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-14 06:00:00',    0.1, 110, '2011-10-14 06:05:03', 302, 0, 0,    0.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-15 06:00:00',    0.2, 110, '2011-10-16 15:13:23', 302, 0, 0,    0.2, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-16 06:00:00',    6.4, 110, '2011-10-16 15:13:23', 302, 0, 0,    6.4, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-17 06:00:00',      2, 110, '2011-10-17 06:19:35', 302, 0, 0,      2, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-18 06:00:00',    0.3, 110, '2011-10-18 05:41:31', 302, 0, 0,    0.3, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84190, '2011-10-19 06:00:00',    7.4, 110, '2011-10-19 06:36:28', 302, 0, 0,    7.4, '0110000000001000', '7000000000000000', '');"

        << "INSERT INTO data VALUES (84070, '2011-10-11 06:00:00',     -1, 110, '2011-10-11 05:25:53', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-12 06:00:00',     -1, 110, '2011-10-12 05:29:19', 302, 0, 0,     -1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-13 06:00:00',    2.1, 110, '2011-10-14 05:34:52', 302, 0, 0,    2.1, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-14 06:00:00',    0.6, 110, '2011-10-14 05:34:52', 302, 0, 0,    0.6, '0110000000001000', '7000000000000000', '');"
        << "INSERT INTO data VALUES (84070, '2011-10-15 06:00:00', -32767, 110, '2011-10-16 00:36:09', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (84070, '2011-10-16 06:00:00', -32767, 110, '2011-10-17 00:30:56', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (84070, '2011-10-17 06:00:00', -32767, 110, '2011-10-18 00:39:35', 302, 0, 0, -32767, '0000003000002000', '7899900000000000', 'QC1-7-110');"
        << "INSERT INTO data VALUES (84070, '2011-10-18 06:00:00',   66.7, 110, '2011-10-19 06:43:04', 302, 0, 0,   66.7, '0140004000002000', '7330900000000001', 'QC1-2-72.b12,QC1-7-110');"
        << "INSERT INTO data VALUES (84070, '2011-10-19 06:00:00',    1.4, 110, '2011-10-19 06:43:04', 302, 0, 0,    1.4, '0110000000001000', '7000000000000000', '');";

    ASSERT_NO_THROW(db->exec(sql.str()));

    ReadProgramOptions params;
    Configure(params, 13, 17);

    algo->run(params);
    ASSERT_EQ(2, bc->count());

    const float expected_corrected[2] = { 10.5, 2.3 };
    const char* expected_controlinfo[2] = { "0000001000007000", "0140004000007000" };
    const char* expected_cfailed_end[2] = { ",QC2N_83520_84190,QC2-redist", ",QC2N_83520_84190,QC2-redist" };
    for(int i=0; i<bc->count(); ++i) {
        const kvalobs::kvData& d = bc->updates()[i];
        EXPECT_EQ(83880, d.stationID()) << " at index " << i;
        EXPECT_FLOAT_EQ(expected_corrected[i], d.corrected()) << " at index " << i;
        EXPECT_EQ(expected_controlinfo[i], d.controlinfo().flagstring()) << " at index " << i;
        EXPECT_TRUE(Helpers::endsWith(d.cfailed(), expected_cfailed_end[i])) << " at index " << i << " cfailed=" << d.cfailed();
    }

    std::list<kvalobs::kvData> cfailedWithQC2;
    ASSERT_NO_THROW(db->selectData(cfailedWithQC2, " WHERE cfailed LIKE '%QC2%'"));
    foreach(const kvalobs::kvData& d, cfailedWithQC2) {
        EXPECT_EQ(83880, d.stationID()) << " data=" << d;
    }

    bc->clear();
    algo->run(params);
    ASSERT_EQ(0, bc->count());
}
